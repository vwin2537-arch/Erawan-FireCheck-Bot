# 📝 บันทึกการพัฒนา - FIRMS LINE Bot
## วันที่ 4 กุมภาพันธ์ 2569

---

## 🎯 สรุปงานที่ทำวันนี้

### 1. Deploy บน Railway ✅
**ปัญหาที่เจอ:**
- Vercel ไม่รองรับ Python scheduler (serverless)
- Health check ล้มเหลวเพราะ endpoint พึ่ง database

**วิธีแก้:**
- ย้ายมา Railway ที่รัน 24/7 ได้
- ทำให้ `/health` endpoint เป็น simple check ไม่พึ่ง database
- สร้างไฟล์ `Dockerfile`, `railway.json`, `Procfile`

---

### 2. Bad Gateway Error ✅
**ปัญหา:** หลัง deploy แล้วเข้าเว็บไม่ได้

**สาเหตุ:** Port mismatch - Railway ใช้ port 8000 แต่ app ใช้ dynamic port

**วิธีแก้:** Hardcode port 8000 ใน `Procfile` และ `railway.json`

---

### 3. Environment Variables หายไป ✅
**ปัญหา:** Bot ไม่ทำงาน, API key หาย

**สาเหตุ:** ลืมใส่ Environment Variables ใน Railway

**วิธีแก้:** Copy จาก `Import.env` ไปวางใน Railway > Variables > Raw Editor

---

### 4. ปรับ Scheduler ให้ประหยัดโควต้า ✅
**เดิม:** ตรวจทุก 10-30 นาที ตลอด 24 ชม.

**ใหม่:** 
- ตรวจเฉพาะช่วง Peak (01:30-06:00 / 13:30-18:00)
- นอกเวลา Peak = หลับ ไม่ยิง API

**ไฟล์ที่แก้:** `app/services/scheduler_service.py`

---

### 5. เพิ่ม Heartbeat Notification ✅
**ความต้องการ:** อยากรู้ว่าบอทยังทำงานอยู่ แม้ไม่เจอ Hotspot

**วิธีแก้:** 
- ถ้าจบรอบแล้วไม่เจอ Hotspot → ส่ง LINE "✅ ไม่พบจุดความร้อน"
- ถ้าเจอ Hotspot → ส่งแจ้งเตือนปกติ (ไม่ส่ง heartbeat ซ้ำ)

---

### 6. Smart Sleep หลังเจอ Hotspot ✅
**ความต้องการ:** หลังเจอ Hotspot แล้ว ไม่ต้องตรวจต่อนานนัก

**วิธีแก้:**
- เจอ Hotspot → ตรวจต่ออีก 1 ชม. → หลับ
- ส่ง LINE "😴 บอทเข้าสู่โหมดพักผ่อน"

---

### 7. อัพเกรดเป็น 3 ดาวเทียม ✅
**เดิม:** VIIRS_SNPP (ดวงเดียว)

**ใหม่:** 
- VIIRS_SNPP
- VIIRS_NOAA20
- VIIRS_NOAA21

**ไฟล์ที่แก้:** `app/services/firms_service.py`

---

### 8. ข้อความแบบ Cumulative ✅
**ความต้องการ:** อยากเห็นข้อมูลแยกดาวเทียม รวมสะสม

**รูปแบบใหม่:**
```
🔥 แจ้งเตือนจุดความร้อน
📅 05/02/2026 14:40
━━━━━━━━━━━━━━━━
🛰️ SNPP - 2 จุด (ถ่าย 12:45)
🛰️ NOAA20 - 1 จุด (ถ่าย 13:30)
🛰️ NOAA21 - 3 จุด (ถ่าย 14:15)
━━━━━━━━━━━━━━━━
📍 รวม: 6 จุด (3/3 ดาวเทียม)
🏔️ พื้นที่: กาญจนบุรี
```

**ไฟล์ที่แก้:**
- `app/services/line_service.py` - เพิ่ม `send_satellite_alert()`
- `app/services/notification_service.py` - ใช้ method ใหม่
- `app/services/scheduler_service.py` - track ดาวเทียมแยก

---

## 📁 ไฟล์ที่สร้าง/แก้ไขวันนี้

| ไฟล์ | การเปลี่ยนแปลง |
| :--- | :--- |
| `Dockerfile` | สร้างใหม่ + ตั้ง timezone Asia/Bangkok |
| `railway.json` | สร้างใหม่สำหรับ Railway |
| `Procfile` | สร้างใหม่ + hardcode port 8000 |
| `Import.env` | Template สำหรับ copy ไป Railway |
| `app/services/scheduler_service.py` | Peak hours, smart sleep, cumulative tracking |
| `app/services/firms_service.py` | เพิ่ม 3 ดาวเทียม |
| `app/services/line_service.py` | เพิ่ม `send_satellite_alert()` |
| `app/services/notification_service.py` | ใช้ format ใหม่ |
| `app/routers/health.py` | Simplify health check |

---

## 🔧 สถาปัตยกรรมปัจจุบัน

```
┌─────────────────────────────────────────────────────┐
│                    Railway (Cloud)                   │
├─────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────┐  │
│  │              FastAPI Application              │  │
│  │  ┌─────────────┐  ┌─────────────────────────┐ │  │
│  │  │  Scheduler  │  │       API Routes        │ │  │
│  │  │ (APScheduler)│  │ /api/check-now         │ │  │
│  │  │ Peak Hours  │  │ /health                │ │  │
│  │  └──────┬──────┘  └─────────────────────────┘ │  │
│  │         │                                     │  │
│  │  ┌──────▼──────────────────────────────────┐  │  │
│  │  │         Notification Service            │  │  │
│  │  │  - Fetch from FIRMS (3 satellites)      │  │  │
│  │  │  - Filter new hotspots                  │  │  │
│  │  │  - Send LINE alerts                     │  │  │
│  │  └─────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────┘  │
│                         │                            │
│                         ▼                            │
│              ┌─────────────────────┐                │
│              │   SQLite Database   │                │
│              │   (hotspots.db)     │                │
│              └─────────────────────┘                │
└─────────────────────────────────────────────────────┘
          │                              │
          ▼                              ▼
┌──────────────────┐          ┌──────────────────────┐
│    NASA FIRMS    │          │   LINE Messaging API │
│  (3 satellites)  │          │   (Push to Group)    │
└──────────────────┘          └──────────────────────┘
```

---

## ⏰ ตารางการทำงานของบอท

| เวลา | สิ่งที่บอททำ |
| :--- | :--- |
| 00:00 - 01:29 | 💤 หลับ |
| **01:30 - 06:00** | 🔍 ตรวจทุก 10 นาที (รอบดึก) |
| 06:00 | ส่ง Heartbeat ถ้าไม่เจอ / หลับเร็วถ้าครบ 3 ดวง |
| 06:01 - 13:29 | 💤 หลับ |
| **13:30 - 18:00** | 🔍 ตรวจทุก 10 นาที (รอบบ่าย) |
| 18:00 | ส่ง Heartbeat ถ้าไม่เจอ / หลับเร็วถ้าครบ 3 ดวง |
| 18:01 - 23:59 | 💤 หลับ |

---

## 📌 สิ่งที่ต้องจำ

1. **Environment Variables** ต้องใส่ใน Railway ให้ครบ
2. **LINE Group ID** ต้องถูกต้อง (เริ่มด้วย C)
3. **Timezone** ต้องเป็น `Asia/Bangkok`
4. **Port** ต้องเป็น `8000`

---

*บันทึกนี้สร้างเมื่อ: 4 กุมภาพันธ์ 2569 เวลา 22:25 น.*

---
---

# 📝 บันทึกการพัฒนา - FIRMS LINE Bot
## วันที่ 5 กุมภาพันธ์ 2569

---

## 🐛 ปัญหาที่พบจากการใช้งานจริง

### ปัญหาที่ 1: ข้อความถูกส่งซ้ำ 2 ครั้ง

**อาการ:**
- บอทส่งข้อความแจ้งเตือน 2 ข้อความ ในเวลาเดียวกัน (01:30 น.)
- ข้อมูลเหมือนกันทุกประการ

**สาเหตุ:**
มีการส่งข้อความ 2 ที่:
1. `notification_service.py` → `send_satellite_alert()` (บรรทัด 86)
2. `scheduler_service.py` → `_send_cumulative_update()` (บรรทัด 117)

**วิธีแก้:**
ลบการส่งจาก `notification_service.py` ให้ส่งจาก `scheduler_service.py` อย่างเดียว

```python
# notification_service.py - ลบบรรทัดนี้
# await self.line.send_satellite_alert(target_to, satellites_for_alert)
```

---

### ปัญหาที่ 2: ข้อมูล Hotspot เป็นของเมื่อวาน

**อาการ:**
- ตอน 01:30 น. ของวันที่ 5/02 บอทส่งข้อมูลที่ "ถ่าย 13:22, 13:44, 14:35"
- เวลาถ่ายเหล่านี้คือช่วงบ่ายของวันที่ 4 (เมื่อวาน)

**สาเหตุ:**
FIRMS API ใช้ `day_range=1` ซึ่งดึงข้อมูล **24 ชั่วโมงย้อนหลัง** ไม่ใช่ข้อมูลของวันปัจจุบัน

```
Timeline:
วันที่ 4, 13:30 → ดาวเทียมถ่ายภาพ (hotspot ของวันที่ 4)
วันที่ 4, 18:00 → Peak รอบบ่ายจบ
วันที่ 5, 00:00 → เปลี่ยนวัน
วันที่ 5, 01:30 → Peak รอบดึกเริ่ม
                → FIRMS API ดึงข้อมูล 24 ชม. = รวมข้อมูลวันที่ 4
                → บอทส่งข้อมูลเก่าของเมื่อวาน!
```

**วิธีแก้:**
เพิ่ม filter ใน `notification_service.py` ให้แสดงเฉพาะ hotspot ที่ `acq_date` = วันนี้ (Thailand timezone)

```python
# notification_service.py - เพิ่มก่อน filter_new_hotspots()
from zoneinfo import ZoneInfo
today_th = datetime.now(tz=ZoneInfo("Asia/Bangkok")).date()
today_hotspots = []
for h in hotspots_data:
    hotspot_date = datetime.strptime(h["acq_date"], "%Y-%m-%d").date()
    if hotspot_date == today_th:
        today_hotspots.append(h)
hotspots_data = today_hotspots
```

---

### ปัญหาที่ 3: ข้อมูลรอบเช้ากับรอบบ่ายไม่รวมกัน

**อาการ:**
- รอบบ่าย (13:30-18:00) เริ่มนับใหม่จาก 0
- ไม่รวมข้อมูลจากรอบเช้า (01:30-06:00)

**สาเหตุ:**
โค้ดรีเซต `satellite_data` เมื่อเข้าสู่ peak period ใหม่

```python
# scheduler_service.py - โค้ดที่ทำให้เกิดปัญหา
if is_peak and not self.was_in_peak:
    self._reset_period_state()  # รีเซตเมื่อเข้า peak!
```

**วิธีแก้:**
ลบการรีเซตเมื่อเข้า peak period ใหม่ ให้รีเซตเฉพาะเมื่อเปลี่ยนวัน (เที่ยงคืน) เท่านั้น

```python
# scheduler_service.py - โค้ดใหม่
# Reset data at midnight only (when date changes)
if self.current_date is not None and self.current_date != today:
    self._reset_period_state()
self.current_date = today

# Track peak state (but don't reset)
self.was_in_peak = is_peak
```

---

## 🔑 บทเรียนสำคัญ: การจัดการเวลาและข้อมูล

### 1. FIRMS API ดึงข้อมูล 24 ชม. ย้อนหลัง
- ไม่ใช่ข้อมูลของ "วันนี้" ในความหมายปกติ
- ต้อง filter ด้วย `acq_date` เอง

### 2. การรีเซตข้อมูลต้องคิดให้ดี
- รีเซตบ่อยเกินไป → ข้อมูลหาย
- รีเซตน้อยเกินไป → ข้อมูลซ้ำ
- **ทางออก**: รีเซตเฉพาะเมื่อเปลี่ยนวัน (เที่ยงคืน)

### 3. ระวังการส่งข้อความซ้ำ
- ถ้ามี service หลายตัว อาจส่งข้อความซ้อนกัน
- **ทางออก**: กำหนดให้มีจุดเดียวที่ส่งข้อความ

### 4. Timezone สำคัญมาก
- FIRMS API คืนค่าเป็น UTC
- ต้องแปลงเป็น Thailand time (UTC+7) ก่อนเปรียบเทียบวันที่
- ใช้ `ZoneInfo("Asia/Bangkok")` เสมอ

---

## 📁 ไฟล์ที่แก้ไขวันนี้

| ไฟล์ | การเปลี่ยนแปลง |
| :--- | :--- |
| `app/services/notification_service.py` | ลบส่งข้อความซ้ำ + เพิ่ม date filter |
| `app/services/scheduler_service.py` | ลบ reset เมื่อเข้า peak, เพิ่ม reset เมื่อเปลี่ยนวัน |
| `.agent/workflows/qa-review.md` | สร้าง QA Review workflow |

---

## ⏰ ตารางการทำงานของบอท (อัพเดต)

| เวลา | สิ่งที่บอททำ | ข้อมูล |
| :--- | :--- | :--- |
| 00:00 | 🔄 รีเซตข้อมูลทั้งหมด | เริ่มวันใหม่ |
| 00:01 - 01:29 | 💤 หลับ | - |
| **01:30 - 06:00** | 🔍 ตรวจทุก 10 นาที | สะสมข้อมูล |
| 06:00 | 📤 ส่ง Heartbeat/Sleep | - |
| 06:01 - 13:29 | 💤 หลับ | ข้อมูลยังอยู่ |
| **13:30 - 18:00** | 🔍 ตรวจทุก 10 นาที | **รวมข้อมูลจากรอบเช้า** |
| 18:00 | 📤 ส่ง Heartbeat/Sleep | - |
| 18:01 - 23:59 | 💤 หลับ | ข้อมูลรอรีเซตเที่ยงคืน |

---

*บันทึกนี้สร้างเมื่อ: 5 กุมภาพันธ์ 2569 เวลา 07:14 น.*
