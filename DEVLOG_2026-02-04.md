# 📝 บันทึกการพัฒนา - FIRMS LINE Bot
## วันที่ 4 กุมภาพันธ์ 2569

---

## 🎯 สรุปงานที่ทำวันนี้

### 1. Deploy บน Railway ✅
**ปัญหาที่เจอ:**
- Vercel ไม่รองรับ Python scheduler (serverless)
- Health check ล้มเหลวเพราะ endpoint พึ่ง database

**วิธีแก้:**
- ย้ายมา Railway ที่รัน 24/7 ได้
- ทำให้ `/health` endpoint เป็น simple check ไม่พึ่ง database
- สร้างไฟล์ `Dockerfile`, `railway.json`, `Procfile`

---

### 2. Bad Gateway Error ✅
**ปัญหา:** หลัง deploy แล้วเข้าเว็บไม่ได้

**สาเหตุ:** Port mismatch - Railway ใช้ port 8000 แต่ app ใช้ dynamic port

**วิธีแก้:** Hardcode port 8000 ใน `Procfile` และ `railway.json`

---

### 3. Environment Variables หายไป ✅
**ปัญหา:** Bot ไม่ทำงาน, API key หาย

**สาเหตุ:** ลืมใส่ Environment Variables ใน Railway

**วิธีแก้:** Copy จาก `Import.env` ไปวางใน Railway > Variables > Raw Editor

---

### 4. ปรับ Scheduler ให้ประหยัดโควต้า ✅
**เดิม:** ตรวจทุก 10-30 นาที ตลอด 24 ชม.

**ใหม่:** 
- ตรวจเฉพาะช่วง Peak (01:30-06:00 / 13:30-18:00)
- นอกเวลา Peak = หลับ ไม่ยิง API

**ไฟล์ที่แก้:** `app/services/scheduler_service.py`

---

### 5. เพิ่ม Heartbeat Notification ✅
**ความต้องการ:** อยากรู้ว่าบอทยังทำงานอยู่ แม้ไม่เจอ Hotspot

**วิธีแก้:** 
- ถ้าจบรอบแล้วไม่เจอ Hotspot → ส่ง LINE "✅ ไม่พบจุดความร้อน"
- ถ้าเจอ Hotspot → ส่งแจ้งเตือนปกติ (ไม่ส่ง heartbeat ซ้ำ)

---

### 6. Smart Sleep หลังเจอ Hotspot ✅
**ความต้องการ:** หลังเจอ Hotspot แล้ว ไม่ต้องตรวจต่อนานนัก

**วิธีแก้:**
- เจอ Hotspot → ตรวจต่ออีก 1 ชม. → หลับ
- ส่ง LINE "😴 บอทเข้าสู่โหมดพักผ่อน"

---

### 7. อัพเกรดเป็น 3 ดาวเทียม ✅
**เดิม:** VIIRS_SNPP (ดวงเดียว)

**ใหม่:** 
- VIIRS_SNPP
- VIIRS_NOAA20
- VIIRS_NOAA21

**ไฟล์ที่แก้:** `app/services/firms_service.py`

---

### 8. ข้อความแบบ Cumulative ✅
**ความต้องการ:** อยากเห็นข้อมูลแยกดาวเทียม รวมสะสม

**รูปแบบใหม่:**
```
🔥 แจ้งเตือนจุดความร้อน
📅 05/02/2026 14:40
━━━━━━━━━━━━━━━━
🛰️ SNPP - 2 จุด (ถ่าย 12:45)
🛰️ NOAA20 - 1 จุด (ถ่าย 13:30)
🛰️ NOAA21 - 3 จุด (ถ่าย 14:15)
━━━━━━━━━━━━━━━━
📍 รวม: 6 จุด (3/3 ดาวเทียม)
🏔️ พื้นที่: กาญจนบุรี
```

**ไฟล์ที่แก้:**
- `app/services/line_service.py` - เพิ่ม `send_satellite_alert()`
- `app/services/notification_service.py` - ใช้ method ใหม่
- `app/services/scheduler_service.py` - track ดาวเทียมแยก

---

## 📁 ไฟล์ที่สร้าง/แก้ไขวันนี้

| ไฟล์ | การเปลี่ยนแปลง |
| :--- | :--- |
| `Dockerfile` | สร้างใหม่ + ตั้ง timezone Asia/Bangkok |
| `railway.json` | สร้างใหม่สำหรับ Railway |
| `Procfile` | สร้างใหม่ + hardcode port 8000 |
| `Import.env` | Template สำหรับ copy ไป Railway |
| `app/services/scheduler_service.py` | Peak hours, smart sleep, cumulative tracking |
| `app/services/firms_service.py` | เพิ่ม 3 ดาวเทียม |
| `app/services/line_service.py` | เพิ่ม `send_satellite_alert()` |
| `app/services/notification_service.py` | ใช้ format ใหม่ |
| `app/routers/health.py` | Simplify health check |

---

## 🔧 สถาปัตยกรรมปัจจุบัน

```
┌─────────────────────────────────────────────────────┐
│                    Railway (Cloud)                   │
├─────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────┐  │
│  │              FastAPI Application              │  │
│  │  ┌─────────────┐  ┌─────────────────────────┐ │  │
│  │  │  Scheduler  │  │       API Routes        │ │  │
│  │  │ (APScheduler)│  │ /api/check-now         │ │  │
│  │  │ Peak Hours  │  │ /health                │ │  │
│  │  └──────┬──────┘  └─────────────────────────┘ │  │
│  │         │                                     │  │
│  │  ┌──────▼──────────────────────────────────┐  │  │
│  │  │         Notification Service            │  │  │
│  │  │  - Fetch from FIRMS (3 satellites)      │  │  │
│  │  │  - Filter new hotspots                  │  │  │
│  │  │  - Send LINE alerts                     │  │  │
│  │  └─────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────┘  │
│                         │                            │
│                         ▼                            │
│              ┌─────────────────────┐                │
│              │   SQLite Database   │                │
│              │   (hotspots.db)     │                │
│              └─────────────────────┘                │
└─────────────────────────────────────────────────────┘
          │                              │
          ▼                              ▼
┌──────────────────┐          ┌──────────────────────┐
│    NASA FIRMS    │          │   LINE Messaging API │
│  (3 satellites)  │          │   (Push to Group)    │
└──────────────────┘          └──────────────────────┘
```

---

## ⏰ ตารางการทำงานของบอท

| เวลา | สิ่งที่บอททำ |
| :--- | :--- |
| 00:00 - 01:29 | 💤 หลับ |
| **01:30 - 06:00** | 🔍 ตรวจทุก 10 นาที (รอบดึก) |
| 06:00 | ส่ง Heartbeat ถ้าไม่เจอ / หลับเร็วถ้าครบ 3 ดวง |
| 06:01 - 13:29 | 💤 หลับ |
| **13:30 - 18:00** | 🔍 ตรวจทุก 10 นาที (รอบบ่าย) |
| 18:00 | ส่ง Heartbeat ถ้าไม่เจอ / หลับเร็วถ้าครบ 3 ดวง |
| 18:01 - 23:59 | 💤 หลับ |

---

## 📌 สิ่งที่ต้องจำ

1. **Environment Variables** ต้องใส่ใน Railway ให้ครบ
2. **LINE Group ID** ต้องถูกต้อง (เริ่มด้วย C)
3. **Timezone** ต้องเป็น `Asia/Bangkok`
4. **Port** ต้องเป็น `8000`

---

*บันทึกนี้สร้างเมื่อ: 4 กุมภาพันธ์ 2569 เวลา 22:25 น.*
