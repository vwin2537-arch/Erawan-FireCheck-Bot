<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_name }} - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <header class="flex justify-between items-center mb-12">
            <div>
                <h1 class="text-3xl font-bold text-red-600">üî• {{ app_name }}</h1>
                <p class="text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏∏‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
            </div>
            <div class="space-x-4">
                <button onclick="testLine()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl font-bold transition-all shadow-sm flex items-center gap-2">
                    <span>üîî ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ö‡∏≠‡∏ó</span>
                </button>
                <button onclick="checkNow()" id="checkBtn"
                    class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-xl font-bold transition-all shadow-sm flex items-center gap-2">
                    <span>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span>
                </button>
            </div>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100">
                <p class="text-sm font-semibold text-gray-400 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</p>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-xl font-bold text-gray-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>
                </div>
            </div>
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100">
                <p class="text-sm font-semibold text-gray-400 mb-2">‡∏à‡∏∏‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                <p id="todayCount" class="text-4xl font-extrabold text-red-500">0 ‡∏à‡∏∏‡∏î</p>
            </div>
            <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100">
                <p class="text-sm font-semibold text-gray-400 mb-2">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
                <p id="lastCheck" class="text-2xl font-bold text-gray-800">00:00:00</p>
            </div>
        </section>

        <section class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-8 py-6 border-b border-gray-50 flex justify-between items-center">
                <h2 class="text-xl font-bold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô)</h2>
                <span class="text-sm text-gray-400">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-gray-50 text-gray-400 text-xs uppercase tracking-wider">
                            <th class="px-8 py-4 font-bold">‡∏û‡∏¥‡∏Å‡∏±‡∏î (Lat, Lon)</th>
                            <th class="px-8 py-4 font-bold">‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö</th>
                            <th class="px-8 py-4 font-bold">‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</th>
                            <th class="px-8 py-4 font-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô</th>
                            <th class="px-8 py-4 font-bold">FRP (MW)</th>
                        </tr>
                    </thead>
                    <tbody id="hotspotTable" class="divide-y divide-gray-50">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        async function loadData() {
            try {
                const response = await fetch('/api/hotspots/today');
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                const hotspots = data.hotspots;

                document.getElementById('todayCount').innerText = `${data.today_count} ‡∏à‡∏∏‡∏î`;

                const table = document.getElementById('hotspotTable');
                table.innerHTML = hotspots.length > 0
                    ? hotspots.map(h => `
                        <tr>
                            <td class="px-8 py-4 font-mono text-sm">${h.latitude.toFixed(4)}, ${h.longitude.toFixed(4)}</td>
                            <td class="px-8 py-4">${h.acq_time} ‡∏ô. (${h.acq_date})</td>
                            <td class="px-8 py-4"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">${h.satellite}</span></td>
                            <td class="px-8 py-4">${h.confidence}</td>
                            <td class="px-8 py-4 font-semibold">${h.frp.toFixed(2)}</td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="5" class="px-8 py-12 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏à‡∏∏‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</td></tr>';

                // Load last log
                const logRes = await fetch('/api/logs?limit=1');
                if (logRes.ok) {
                    const logs = await logRes.json();
                    if (logs.length > 0) {
                        const log = logs[0];
                        const date = new Date(log.checked_at);
                        document.getElementById('lastCheck').innerText = date.toLocaleTimeString('th-TH');
                    } else {
                        document.getElementById('lastCheck').innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('todayCount').innerText = "error";
                document.getElementById('hotspotTable').innerHTML = '<tr><td colspan="5" class="px-8 py-12 text-center text-red-400">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            }
        }

        async function checkNow() {
            const btn = document.getElementById('checkBtn');
            const originalText = btn.innerText;
            btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';
            btn.disabled = true;
            btn.classList.add('opacity-50');

            try {
                const response = await fetch('/api/check-now', { method: 'POST' });
                const result = await response.json();

                // Detailed debug alert
                let msg = `‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\n`;
                msg += `--------------------------\n`;
                msg += `- ‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${result.hotspots_found} ‡∏à‡∏∏‡∏î\n`;
                msg += `- ‡∏û‡∏ö‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ${result.new_hotspots} ‡∏à‡∏∏‡∏î\n`;
                msg += `- ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô LINE: ${result.notification_sent ? '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á'}\n`;
                if (result.notification_error) {
                    msg += `- ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡πà‡∏á: ${result.notification_error}\n`;
                }
                msg += `- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ${result.total_in_db} ‡∏à‡∏∏‡∏î\n`;

                if (result.all_satellites_data) {
                    msg += `\nüõ∞Ô∏è ‡∏™‡∏£‡∏∏‡∏õ‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Manual Check):\n`;
                    for (const [sat, data] of Object.entries(result.all_satellites_data)) {
                        msg += `‚Ä¢ ${sat}: ${data.count} ‡∏à‡∏∏‡∏î (${data.time})\n`;
                    }
                }

                alert(msg);
                loadData();
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }

        async function testLine() {
            try {
                const response = await fetch('/api/test-line', { method: 'POST' });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ LINE ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
                } else {
                    alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.message);
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö');
            }
        }

        loadData();
        setInterval(loadData, 60000); // 1 min auto-refresh
    </script>
</body>

</html>